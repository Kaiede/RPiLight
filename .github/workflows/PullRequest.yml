name: Full CI
on:
  pull_request:
    types: [assigned, opened, synchronize, reopened]
  push:
    branches:
      - master

jobs:
  raspbianStretchBuild:
    name: ARM Package - ${{ matrix.raspbian }}
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        swift-version: [5.1.5]
        raspbian: [stretch, buster]
    steps:
      - name: Checkout
        uses: actions/checkout@v1.0.0
      - name: Build in QEMU
        uses: uraimo/run-on-arch-action@v1.0.5
        id: runcmd
        with:
          architecture: armv6
          distribution: ${{ matrix.raspbian }}
          run: |
            apt update
            apt install -y clang-3.8 libncurses-dev libxml2-dev libicu-dev libcurl4-nss-dev
            apt install -y curl git
            update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-3.8 100
            update-alternatives --install /usr/bin/clang clang /usr/bin/clang-3.8 100
            curl -o swift-${{ matrix.swift-version }}.tgz -L https://github.com/uraimo/buildSwiftOnARM/releases/download/${{ matrix.swift-version }}/swift-${{ matrix.swift-version }}-armv6-RPi0123-RaspbianStretch.tgz
            tar xzf swift-${{ matrix.swift-version }}.tgz
            ./build.sh package
      - uses: actions/upload-artifact@v1
        with:
          name: ${{ matrix.raspbian }}-package
          path: .package/out

  swiftLintChecks:
    name: Swiftlint
    runs-on: macOS-latest
    strategy:
      max-parallel: 1
        
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Swiftlint
        run: |
          brew install swiftlint
          swiftlint --strict
